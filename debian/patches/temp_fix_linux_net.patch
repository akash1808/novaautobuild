Works around https://bugs.launchpad.net/nova/+bug/929127

Can be dropped when https://review.openstack.org/#change,3934 is merged

adam_g 02/08/2012

Index: nova-2012.1+git201202081831/nova/network/linux_net.py
===================================================================
--- nova-2012.1+git201202081831.orig/nova/network/linux_net.py	2012-02-08 16:32:45.726675756 -0800
+++ nova-2012.1+git201202081831/nova/network/linux_net.py	2012-02-08 16:33:03.130676640 -0800
@@ -458,7 +458,7 @@
     """Bind ip to public interface."""
     _execute('ip', 'addr', 'add', str(floating_ip) + '/32',
              'dev', device,
-             run_as_root=True, check_exit_code=[0, 254])
+             run_as_root=True, check_exit_code=[0, 2, 254])
     if FLAGS.send_arp_for_ha:
         _execute('arping', '-U', floating_ip,
                  '-A', '-I', device,
@@ -469,14 +469,14 @@
     """Unbind a public ip from public interface."""
     _execute('ip', 'addr', 'del', str(floating_ip) + '/32',
              'dev', device,
-             run_as_root=True, check_exit_code=[0, 254])
+             run_as_root=True, check_exit_code=[0, 2, 254])
 
 
 def ensure_metadata_ip():
     """Sets up local metadata ip."""
     _execute('ip', 'addr', 'add', '169.254.169.254/32',
              'scope', 'link', 'dev', 'lo',
-             run_as_root=True, check_exit_code=[0, 254])
+             run_as_root=True, check_exit_code=[0, 2, 254])
 
 
 def ensure_vpn_forward(public_ip, port, private_ip):
@@ -549,10 +549,10 @@
                          check_exit_code=[0, 7])
         for ip_params in old_ip_params:
             _execute(*_ip_bridge_cmd('del', ip_params, dev),
-                        run_as_root=True, check_exit_code=[0, 254])
+                        run_as_root=True, check_exit_code=[0, 2, 254])
         for ip_params in new_ip_params:
             _execute(*_ip_bridge_cmd('add', ip_params, dev),
-                        run_as_root=True, check_exit_code=[0, 254])
+                        run_as_root=True, check_exit_code=[0, 2, 254])
         if gateway:
             _execute('route', 'add', 'default', 'gw', gateway,
                      run_as_root=True, check_exit_code=[0, 7])
@@ -1048,9 +1048,9 @@
                 if fields and fields[0] == 'inet':
                     params = fields[1:-1]
                     _execute(*_ip_bridge_cmd('del', params, fields[-1]),
-                                run_as_root=True, check_exit_code=[0, 254])
+                                run_as_root=True, check_exit_code=[0, 2, 254])
                     _execute(*_ip_bridge_cmd('add', params, bridge),
-                                run_as_root=True, check_exit_code=[0, 254])
+                                run_as_root=True, check_exit_code=[0, 2, 254])
             if old_gateway:
                 _execute('route', 'add', 'default', 'gw', old_gateway,
                          run_as_root=True, check_exit_code=[0, 7])
